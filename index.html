<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Gastos — App Optimizada</title>
  <meta name="description" content="Aplicación para control de gastos. Responsive, exportar a Excel/PDF, importar desde Excel, gráficas y almacenamiento local." />

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- Plugins CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.6.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

  <style>
    :root {
      --bg:#F6F8FF;
      --card:#FFFFFF;
      --accent:#4f52ba;
      --muted:#6c6f84;
      --radius:12px;
    }
    html,body{height:100%}
    body{font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--muted); margin:0}
    .navbar{background:linear-gradient(90deg,#3d3fb7,#6f72ff)}
    .navbar-brand{color:#fff; font-weight:700}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:0 6px 28px rgba(20,20,60,0.06)}
    .kpi{border-left:4px solid rgba(79,82,186,0.12)}
    .btn-accent{background:var(--accent); color:#fff; border:0}
    .select2-container--bootstrap4 .select2-selection{height:38px}
    .footer-note{font-size:0.85rem; color:#9aa0c0}
    @media (max-width:575px){ .desktop-only{display:none} .chart-wrap canvas{height:220px!important} }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-dark py-3">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-wallet me-2"></i>Control de Gastos</a>
      <div class="d-flex align-items-center ms-auto">
        <button id="btnToggleTheme" class="btn btn-sm btn-outline-light me-2" title="Cambiar tema"><i class="fa-solid fa-moon"></i></button>
        <button class="btn btn-light btn-sm me-2" data-bs-toggle="offcanvas" data-bs-target="#offFilters"><i class="fa-solid fa-filter"></i></button>
        <div class="dropdown">
          <button class="btn btn-light btn-sm dropdown-toggle" id="menuActions" data-bs-toggle="dropdown" aria-expanded="false"><i class="fa-solid fa-gear"></i></button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="menuActions">
            <li><a class="dropdown-item" href="#" id="btnExportAllExcel">Exportar todo a Excel</a></li>
            <li><a class="dropdown-item" href="#" id="btnExportPDF">Exportar reporte PDF</a></li>
            <li><a class="dropdown-item" href="#" id="btnClearStorage">Borrar datos locales</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="container py-4">
    <!-- Header + KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-8">
        <div class="card p-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <h5 class="mb-0">Resumen</h5>
              <small class="text-muted">Visión rápida de tus gastos</small>
            </div>
            <div class="text-end">
              <small class="text-muted">Datos guardados localmente</small>
              <div class="fw-semibold" id="lastSaved">—</div>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-12 col-md-4">
              <div class="card p-3 kpi">
                <small class="text-muted">Total (mes)</small>
                <div class="d-flex align-items-center justify-content-between">
                  <h3 id="kpiTotal">$0.00</h3>
                  <div class="text-end">
                    <small class="text-muted">Variación</small>
                    <div id="kpiVar">0%</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="card p-3 kpi">
                <small class="text-muted">Categoría más gastada</small>
                <h5 id="kpiTopCat">—</h5>
                <small id="kpiTopCatAmount" class="text-muted">—</small>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="card p-3 kpi">
                <small class="text-muted">Método favorito</small>
                <h5 id="kpiTopMethod">—</h5>
                <small id="kpiTopMethodCnt" class="text-muted">—</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="col-12 col-lg-4">
        <div class="card p-3 h-100 d-flex flex-column justify-content-between">
          <div>
            <h6 class="mb-1">Acciones rápidas</h6>
            <p class="mb-2 small text-muted">Exportar/importar y control rápido</p>
            <div class="d-grid gap-2">
              <button class="btn btn-accent btn-sm" id="btnQuickAdd"><i class="fa-solid fa-plus me-2"></i>Agregar gasto rápido</button>
              <label class="btn btn-outline-secondary btn-sm mb-0">
                <i class="fa-solid fa-file-excel me-2"></i>Importar Excel
                <input type="file" id="inputImportExcel" accept=".xls,.xlsx,.csv" hidden>
              </label>
              <button class="btn btn-outline-primary btn-sm" id="btnExportVisibleExcel"><i class="fa-solid fa-file-export me-2"></i>Exportar visible a Excel</button>
            </div>
          </div>
          <div class="footer-note mt-3">Tip: importa Excel con columnas: Fecha, Categoría, Descripción, Método, Monto</div>
        </div>
      </div>
    </div>

    <!-- FORM + TABLE -->
    <div class="row g-3">
      <div class="col-12 col-xl-4">
        <div class="card p-3">
          <h6>Agregar gasto</h6>
          <form id="frmAdd" class="mt-2">
            <div class="mb-2">
              <label class="form-label small">Fecha</label>
              <!-- readonly: evitamos escribir manualmente -->
              <input id="inputFecha" class="form-control" placeholder="Selecciona la fecha" readonly required />
            </div>
            <div class="mb-2">
              <label class="form-label small">Categoría</label>
              <select id="inputCategoria" class="form-select select2" required>
                <option>Alimentos</option><option>Transporte</option><option>Vivienda</option><option>Servicios</option>
                <option>Salud</option><option>Ocio</option><option>Otros</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label small">Método</label>
              <select id="inputMetodo" class="form-select select2">
                <option>Efectivo</option><option>Tarjeta Débito</option><option>Tarjeta Crédito</option><option>Transferencia</option><option>Otro</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label small">Monto</label>
              <input id="inputMonto" class="form-control" placeholder="0.00" required />
            </div>
            <div class="mb-2">
              <label class="form-label small">Descripción</label>
              <input id="inputDesc" class="form-control" />
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-accent" type="submit"><i class="fa-solid fa-check me-2"></i>Guardar</button>
              <button id="btnResetForm" type="button" class="btn btn-outline-secondary">Limpiar</button>
            </div>
          </form>
        </div>
      </div>

      <div class="col-12 col-xl-8">
        <div class="card p-3">
          <div class="d-flex justify-content-between mb-3">
            <div>
              <h6 class="mb-0">Gastos registrados</h6>
              <small class="text-muted">Filtra, exporta o importa</small>
            </div>
            <div class="d-flex gap-2">
              <input type="text" id="searchGlobal" class="form-control form-control-sm" placeholder="Buscar...">
              <button id="btnRefresh" class="btn btn-sm btn-outline-secondary">Refrescar</button>
            </div>
          </div>

          <div class="table-responsive">
            <table id="tblGastos" class="table table-striped table-hover nowrap" style="width:100%">
              <thead class="table-light">
                <tr>
                  <th>Fecha</th><th>Categoría</th><th>Descripción</th><th>Método</th><th class="text-end">Monto</th><th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-6">
        <div class="card p-3 chart-wrap">
          <h6>Gasto por categoría</h6>
          <canvas id="chartCat" height="220"></canvas>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card p-3 chart-wrap">
          <h6>Gasto por mes</h6>
          <canvas id="chartMes" height="220"></canvas>
        </div>
      </div>
    </div>

    <footer class="mt-4 text-muted small">Hecho con ❤️ — Exporta a Excel, PDF, CSV. Datos locales (localForage).</footer>
  </main>

  <!-- OFFCANVAS FILTERS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offFilters">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Filtros</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-3">
        <label class="form-label small">Rango de fechas</label>
        <input id="filtroRango" class="form-control" placeholder="Selecciona rango" readonly />
      </div>
      <div class="mb-3">
        <label class="form-label small">Categoría</label>
        <select id="filtroCategoria" class="form-select select2" multiple></select>
      </div>
      <div class="mb-3">
        <label class="form-label small">Método</label>
        <select id="filtroMetodo" class="form-select select2" multiple></select>
      </div>
      <div class="d-grid">
        <button id="btnApplyFilters" class="btn btn-accent">Aplicar filtros</button>
      </div>
    </div>
  </div>

  <!-- SCRIPTS: libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

  <!-- Charts, pickers, helpers -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5/dist/autoNumeric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // =================== Setup ===================
  dayjs.locale('es');
  dayjs.extend(dayjs_plugin_customParseFormat);

  const $ = jQuery;
  const DB = localforage.createInstance({ name: 'gastos-app-v1' });

  // Cached selectors
  const sel = {
    inputFecha: '#inputFecha',
    filtroRango: '#filtroRango',
    inputCategoria: '#inputCategoria',
    inputMetodo: '#inputMetodo',
    inputMonto: '#inputMonto',
    inputDesc: '#inputDesc',
    frmAdd: '#frmAdd',
    tblGastos: '#tblGastos',
    searchGlobal: '#searchGlobal',
    inputImportExcel: '#inputImportExcel',
    btnExportVisibleExcel: '#btnExportVisibleExcel',
    btnExportAllExcel: '#btnExportAllExcel',
    btnExportPDF: '#btnExportPDF',
    btnApplyFilters: '#btnApplyFilters',
    filtroCategoria: '#filtroCategoria',
    filtroMetodo: '#filtroMetodo',
    btnQuickAdd: '#btnQuickAdd',
    btnClearStorage: '#btnClearStorage',
    btnRefresh: '#btnRefresh',
    lastSaved: '#lastSaved'
  };

  // App state
  let gastos = [];
  let dt = null;
  let chartCat = null;
  let chartMes = null;
  let anMonto = null; // AutoNumeric instance

  const defaultCats = ['Alimentos','Transporte','Vivienda','Servicios','Salud','Ocio','Otros'];
  const defaultMethods = ['Efectivo','Tarjeta Débito','Tarjeta Crédito','Transferencia','Otro'];

  // Helpers
  const fmtMoney = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(+v||0);
  const safeParseFloat = s => parseFloat(String(s).replace(/[^0-9.-]/g,'')) || 0;

  // Converts XLSX.SSF.parse_date_code result or numeric serial to Date
  function excelSerialToDate(val){
    // If number (Excel serial)
    if(typeof val === 'number'){
      // XLSX.SSF.parse_date_code returns {y,m,d,H,M,S} for serials
      const pc = XLSX.SSF.parse_date_code(val);
      if(pc && pc.y) return new Date(pc.y, pc.m-1, pc.d, pc.H||0, pc.M||0, pc.S||0);
      // fallback
      const dt = (val - (25567 + 2)) * 86400 * 1000; // Excel serial to JS date (approx)
      return new Date(dt);
    }
    // If string, try multiple formats with dayjs
    const d = dayjs(val, ['DD/MM/YYYY','YYYY-MM-DD','MM/DD/YYYY','DD-MM-YYYY','YYYY/MM/DD','D/M/YYYY'], true);
    if(d.isValid()) return d.toDate();
    const parsed = Date.parse(val);
    return isNaN(parsed) ? new Date() : new Date(parsed);
  }

  // =============== UI init ===============
  function initUI(){
    // Select2
    $('.select2').select2({ theme:'bootstrap4', width:'100%' });
    // fill filters
    defaultCats.forEach(c => $('#filtroCategoria').append(`<option>${c}</option>`));
    defaultMethods.forEach(m => $('#filtroMetodo').append(`<option>${m}</option>`));
    $('#filtroCategoria').trigger('change'); $('#filtroMetodo').trigger('change');

    // Flatpickr instances (single init)
    flatpickr(sel.inputFecha, {
      dateFormat: 'd/m/Y',
      altInput: true,
      altFormat: 'd F Y',
      defaultDate: new Date(),
      locale: 'es',
      allowInput: false,
      disableMobile: false,
      clickOpens: true
    });

    flatpickr(sel.filtroRango, {
      mode: 'range',
      dateFormat: 'd/m/Y',
      altInput: true,
      altFormat: 'd F Y',
      locale: 'es',
      allowInput: false
    });

    // AutoNumeric instance for mount input
    anMonto = new AutoNumeric(sel.inputMonto, { currencySymbol: '', decimalPlaces: 2, digitGroupSeparator: ',', decimalCharacter: '.' });

    // Theme toggle
    $('#btnToggleTheme').on('click', () => {
      const cur = document.documentElement.getAttribute('data-bs-theme') || 'light';
      const next = cur === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-bs-theme', next);
      localStorage.setItem('theme', next);
    });
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme) document.documentElement.setAttribute('data-bs-theme', savedTheme);
  }

  // =============== Table init ===============
  function initTable(){
    dt = $(sel.tblGastos).DataTable({
      data: [],
      columns: [
        { data: 'fecha', width:'12%' },
        { data: 'categoria' },
        { data: 'descripcion' },
        { data: 'metodo', width:'12%' },
        { data: 'monto', className:'text-end', width:'12%' },
        { data: null, orderable:false, className:'text-center', width:'12%', render: actionsRender }
      ],
      responsive: true,
      order: [[0, 'desc']],
      dom: 'Bfrtip',
      buttons: [
        { extend: 'excelHtml5', text: '<i class="fa-solid fa-file-excel"></i> Excel', className:'btn btn-sm btn-outline-success' },
        { extend: 'csvHtml5', text: '<i class="fa-solid fa-file-csv"></i> CSV', className:'btn btn-sm btn-outline-secondary' },
        { extend: 'pdfHtml5', text: '<i class="fa-solid fa-file-pdf"></i> PDF', className:'btn btn-sm btn-outline-danger' },
        { extend: 'print', text: '<i class="fa-solid fa-print"></i> Imprimir', className:'btn btn-sm btn-outline-primary' }
      ],
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
    });

    // Actions events via delegation
    $(sel.tblGastos + ' tbody').on('click', '.btn-edit', function(){ const id = $(this).data('id'); openEditModal(id); });
    $(sel.tblGastos + ' tbody').on('click', '.btn-delete', function(){ const id = $(this).data('id'); deleteGasto(id); });

    // Search
    $(sel.searchGlobal).on('input', function(){ dt.search(this.value).draw(); });

    // Toolbar actions
    $(sel.btnExportVisibleExcel).on('click', exportVisibleToExcel);
    $(sel.btnExportAllExcel).on('click', exportAllToExcel);
    $(sel.btnExportPDF).on('click', ()=> $('.buttons-pdf').click());
  }

  function actionsRender(row){
    return `
      <div class="btn-group" role="group">
        <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${row.id}" title="Editar"><i class="fa-solid fa-pen"></i></button>
        <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${row.id}" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
      </div>`;
  }

  // =============== Charts ===============
  function initCharts(){
    const ctxCat = document.getElementById('chartCat').getContext('2d');
    const ctxMes = document.getElementById('chartMes').getContext('2d');

    chartCat = new Chart(ctxCat, {
      type: 'doughnut',
      data: { labels: [], datasets: [{ data: [] }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    chartMes = new Chart(ctxMes, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Gasto (MXN)', data: [], backgroundColor: 'rgba(79,82,186,0.7)' }] },
      options: {
        scales: { y: { beginAtZero:true, ticks: { callback: v => fmtMoney(v) } } },
        plugins: { legend: { display:false } }
      }
    });
  }

  // =============== Storage & CRUD ===============
  async function loadFromStorage(){
    const arr = await DB.getItem('gastos');
    gastos = Array.isArray(arr) ? arr : [];
    if(!gastos.length){ seedDemo(); await saveToStorage(); }
    renderAll();
  }

  async function saveToStorage(){
    await DB.setItem('gastos', gastos);
    $(sel.lastSaved).text(dayjs().format('DD/MM/YYYY HH:mm:ss'));
  }

  function seedDemo(){
    gastos = [
      { id: crypto.randomUUID(), fechaISO: dayjs().subtract(2,'day').toDate(), categoria:'Alimentos', descripcion:'Supermercado', metodo:'Tarjeta Débito', monto:550.30 },
      { id: crypto.randomUUID(), fechaISO: dayjs().subtract(1,'day').toDate(), categoria:'Transporte', descripcion:'Gasolina', metodo:'Efectivo', monto:300 },
      { id: crypto.randomUUID(), fechaISO: dayjs().subtract(10,'day').toDate(), categoria:'Servicios', descripcion:'Internet', metodo:'Transferencia', monto:499 },
      { id: crypto.randomUUID(), fechaISO: dayjs().subtract(20,'day').toDate(), categoria:'Vivienda', descripcion:'Renta', metodo:'Transferencia', monto:6000 }
    ];
  }

  function formatForTable(g){
    return {
      id: g.id,
      fecha: dayjs(g.fechaISO).format('DD/MM/YYYY'),
      categoria: g.categoria,
      descripcion: g.descripcion || '',
      metodo: g.metodo,
      monto: fmtMoney(g.monto)
    };
  }

  async function addGasto(payload){
    const g = { id: crypto.randomUUID(), ...payload };
    gastos.unshift(g);
    await saveToStorage();
    renderAll();
    return g;
  }

  async function updateGasto(id, payload){
    const idx = gastos.findIndex(x=>x.id===id);
    if(idx === -1) return null;
    gastos[idx] = { ...gastos[idx], ...payload };
    await saveToStorage();
    renderAll();
    return gastos[idx];
  }

  async function deleteGasto(id){
    const g = gastos.find(x=>x.id===id);
    if(!g) return;
    const res = await Swal.fire({ title:'Eliminar', text:`Eliminar "${g.descripcion || g.categoria}"?`, icon:'warning', showCancelButton:true, confirmButtonText:'Sí, eliminar' });
    if(res.isConfirmed){
      gastos = gastos.filter(x=>x.id !== id);
      await saveToStorage();
      renderAll();
      Swal.fire('Eliminado','Gasto eliminado','success');
    }
  }

  // =============== Form handlers ===============
  function bindForm(){
    $(sel.frmAdd).on('submit', async function(e){
      e.preventDefault();
      const fechaStr = $(sel.inputFecha).val();
      const fecha = dayjs(fechaStr,'DD/MM/YYYY').toDate();
      const categoria = $(sel.inputCategoria).val();
      const metodo = $(sel.inputMetodo).val();
      const descripcion = $(sel.inputDesc).val();
      const monto = Number(anMonto.getNumber()) || 0;
      if(!monto || !fecha || !categoria) return Swal.fire('Error','Revisa los campos requeridos','error');
      await addGasto({ fechaISO: fecha, categoria, descripcion, metodo, monto });
      Swal.fire('Guardado','Gasto agregado correctamente','success');
      this.reset();
      anMonto.clear(); // reset AutoNumeric
      // reset default selects
      $(sel.inputCategoria).val('Alimentos').trigger('change');
      $(sel.inputMetodo).val('Efectivo').trigger('change');
      // set date to today without re-initializing flatpickr instance
      const fp = document.querySelector(sel.inputFecha)._flatpickr;
      if(fp) fp.setDate(new Date(), true, 'd/m/Y');
    });

    $('#btnResetForm').on('click', function(){ $(sel.frmAdd)[0].reset(); anMonto.clear(); });

    $(sel.btnQuickAdd).on('click', () => {
      Swal.fire({
        title:'Agregar rápido',
        html:`<input id='qFecha' class='swal2-input' placeholder='dd/mm/yyyy' value='${dayjs().format('DD/MM/YYYY')}'><input id='qDesc' class='swal2-input' placeholder='Descripción'><input id='qMonto' class='swal2-input' placeholder='Monto'>`,
        focusConfirm:false,
        preConfirm: () => ({ fecha: $('#qFecha').val(), desc: $('#qDesc').val(), monto: safeParseFloat($('#qMonto').val()) })
      }).then(async (res) => {
        if(res.value){
          const f = dayjs(res.value.fecha,'DD/MM/YYYY').toDate();
          await addGasto({ fechaISO: f, categoria:'Otros', descripcion: res.value.desc, metodo: 'Efectivo', monto: res.value.monto });
          Swal.fire('Agregado','Gasto rápido agregado','success');
        }
      });
    });
  }

  // =============== Edit modal ===============
  function openEditModal(id){
    const g = gastos.find(x=>x.id === id);
    if(!g) return;
    Swal.fire({
      title: 'Editar gasto',
      html: `
        <input id='eFecha' class='swal2-input' value='${dayjs(g.fechaISO).format('DD/MM/YYYY')}' readonly />
        <input id='eCategoria' class='swal2-input' value='${g.categoria}' />
        <input id='eMetodo' class='swal2-input' value='${g.metodo}' />
        <input id='eDescripcion' class='swal2-input' value='${g.descripcion || ''}' />
        <input id='eMonto' class='swal2-input' value='${g.monto}' />
      `,
      didOpen: () => {
        // attach flatpickr to the swal input (small, for convenience)
        flatpickr('#eFecha', { dateFormat:'d/m/Y', altInput:false, locale:'es', allowInput:false });
      },
      focusConfirm:false,
      preConfirm: () => {
        return {
          fecha: $('#eFecha').val(),
          categoria: $('#eCategoria').val(),
          metodo: $('#eMetodo').val(),
          descripcion: $('#eDescripcion').val(),
          monto: safeParseFloat($('#eMonto').val())
        };
      }
    }).then(async (res) => {
      if(res.value){
        const f = dayjs(res.value.fecha,'DD/MM/YYYY').toDate();
        await updateGasto(id, { fechaISO: f, categoria: res.value.categoria, metodo: res.value.metodo, descripcion: res.value.descripcion, monto: res.value.monto });
        Swal.fire('Actualizado','Gasto actualizado','success');
      }
    });
  }

  // =============== Charts rebuild & KPIs ===============
  function rebuildCharts(){
    const filtered = applyFilters(gastos);
    // by category
    const byCat = {};
    filtered.forEach(g => byCat[g.categoria] = (byCat[g.categoria] || 0) + g.monto);
    const catLabels = Object.keys(byCat);
    const catValues = Object.values(byCat);
    chartCat.data.labels = catLabels;
    chartCat.data.datasets[0].data = catValues;
    chartCat.update();

    // by month
    const byMonth = {};
    filtered.forEach(g => {
      const k = dayjs(g.fechaISO).format('YYYY-MM');
      byMonth[k] = (byMonth[k] || 0) + g.monto;
    });
    const months = Object.keys(byMonth).sort();
    chartMes.data.labels = months.map(m => dayjs(m + '-01').format('MMM YYYY'));
    chartMes.data.datasets[0].data = months.map(m => byMonth[m]);
    chartMes.update();
  }

  function updateKPIs(){
    const now = dayjs();
    const currentMonth = now.format('YYYY-MM');
    const totalMonth = gastos.filter(g => dayjs(g.fechaISO).format('YYYY-MM') === currentMonth).reduce((a,b) => a + b.monto, 0);
    $('#kpiTotal').text(fmtMoney(totalMonth));

    const byCat = {};
    gastos.forEach(g => byCat[g.categoria] = (byCat[g.categoria]||0) + g.monto);
    const topCat = Object.entries(byCat).sort((a,b) => b[1] - a[1])[0];
    $('#kpiTopCat').text(topCat ? topCat[0] : '—');
    $('#kpiTopCatAmount').text(topCat ? fmtMoney(topCat[1]) : '—');

    const byMethod = {};
    gastos.forEach(g => byMethod[g.metodo] = (byMethod[g.metodo]||0) + 1);
    const topM = Object.entries(byMethod).sort((a,b) => b[1]-a[1])[0];
    $('#kpiTopMethod').text(topM ? topM[0] : '—');
    $('#kpiTopMethodCnt').text(topM ? `${topM[1]} movimientos` : '—');
  }

  // =============== Filters ===============
  function applyFilters(data){
    let res = [...data];
    const rango = $('#filtroRango').val();
    const cats = $('#filtroCategoria').val() || [];
    const mets = $('#filtroMetodo').val() || [];
    if(rango && rango.includes(' to ')){
      const parts = rango.split(' to ');
      const from = dayjs(parts[0],'DD/MM/YYYY').startOf('day');
      const to = dayjs(parts[1],'DD/MM/YYYY').endOf('day');
      res = res.filter(x => dayjs(x.fechaISO).isAfter(from.subtract(1,'ms')) && dayjs(x.fechaISO).isBefore(to.add(1,'ms')));
    }
    if(cats.length) res = res.filter(x => cats.includes(x.categoria));
    if(mets.length) res = res.filter(x => mets.includes(x.metodo));
    return res;
  }

  $('#btnApplyFilters').on('click', () => {
    rebuildCharts();
    Swal.fire('Filtros','Aplicados','success');
  });

  // =============== Export / Import ===============
  function exportVisibleToExcel(){
    const visible = dt.rows({ search: 'applied' }).data().toArray();
    const rows = visible.map(r => ({ Fecha: r.fecha, Categoria: r.categoria, Descripcion: r.descripcion, Metodo: r.metodo, Monto: r.monto }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type:'array' });
    saveAs(new Blob([wbout], { type:'application/octet-stream' }), `gastos-visible-${dayjs().format('YYYYMMDD-HHmmss')}.xlsx`);
  }

  function exportAllToExcel(){
    const rows = gastos.map(g => ({ Fecha: dayjs(g.fechaISO).format('DD/MM/YYYY'), Categoria: g.categoria, Descripcion: g.descripcion, Metodo: g.metodo, Monto: g.monto }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    saveAs(new Blob([wbout], { type:'application/octet-stream' }), `gastos-todo-${dayjs().format('YYYYMMDD-HHmmss')}.xlsx`);
  }

  // Import Excel / CSV
  $('#inputImportExcel').on('change', function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    const ext = (file.name || '').split('.').pop().toLowerCase();
    if(ext === 'csv'){
      // handle CSV with PapaParse
      Papa.parse(file, { header:true, skipEmptyLines:true, complete: async (res) => {
        const rows = res.data || [];
        const nuevos = rows.map(r => ({
          id: crypto.randomUUID(),
          fechaISO: excelSerialToDate(r.Fecha || r.date || r.fecha),
          categoria: r.Categoria || r.categoria || 'Otros',
          descripcion: r.Descripcion || r.descripcion || '',
          metodo: r.Metodo || r.metodo || 'Otro',
          monto: safeParseFloat(r.Monto || r.monto || 0)
        }));
        gastos.unshift(...nuevos);
        await saveToStorage(); renderAll();
        Swal.fire('Importado', `${nuevos.length} registros importados`, 'success');
        e.target.value = '';
      }});
      return;
    }

    reader.onload = function(ev){
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      const nuevos = rows.map(r => ({
        id: crypto.randomUUID(),
        fechaISO: excelSerialToDate(r.Fecha || r.Date || r.fecha || r.Fecha_hu || r['Fecha']),
        categoria: r.Categoria || r.categoria || 'Otros',
        descripcion: r.Descripcion || r.Descripción || r.descripcion || '',
        metodo: r.Metodo || r.metodo || 'Otro',
        monto: safeParseFloat(r.Monto || r.monto || r.Amount || 0)
      }));
      gastos.unshift(...nuevos);
      saveToStorage().then(() => {
        renderAll();
        Swal.fire('Importado', `${nuevos.length} registros importados`, 'success');
        e.target.value = '';
      });
    };
    reader.readAsArrayBuffer(file);
  });

  // =============== Render all ===============
  function renderAll(){
    dt.clear();
    gastos.forEach(g => dt.row.add(formatForTable(g)));
    dt.draw(false);
    rebuildCharts();
    updateKPIs();
  }

  // =============== Misc actions ===============
  $('#btnRefresh').on('click', () => { renderAll(); Swal.fire('Listo','Datos actualizados','success'); });

  $('#btnClearStorage').on('click', async () => {
    const ok = await Swal.fire({ title:'Confirmar', text:'Borrar todos los datos de este navegador?', showCancelButton:true });
    if(ok.isConfirmed){
      gastos = []; await saveToStorage(); renderAll(); Swal.fire('Borrado','Datos eliminados','success');
    }
  });

  // Export PDF programmatic (uses DataTables PDF button already present)
  $('#btnExportPDF').on('click', () => $('.buttons-pdf').click());

  // =============== Init on load ===============
  $(async function(){
    initUI();
    initTable();
    initCharts();
    bindForm();
    await loadFromStorage();
  });

  // Utility parseMoney (fallback)
  function parseMoneyFallback(s){ return safeParseFloat(s); }
  </script>
</body>
</html>
